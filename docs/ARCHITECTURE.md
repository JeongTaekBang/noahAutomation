# NOAH PO Auto-Generator 아키텍처 문서

> 이 프로젝트가 어떻게 동작하는지 쉽게 설명하는 문서입니다.

---

## 1. 프로젝트 목적

```
┌─────────────────────────────────────────────────────────────────┐
│                        비즈니스 배경                             │
├─────────────────────────────────────────────────────────────────┤
│  고객 ──PO──▶ RCK (Rotork Korea) ──발주서──▶ NOAH (공장)       │
│                    ↑                         ↓                  │
│             D365 CE 시스템             D365 F&O 시스템          │
│           (Lead → Quote → SO)        (SO → WO → Invoice)        │
│                                                                 │
│  ⚠️ ERP가 통합되지 않아서 RCK→NOAH 발주는 "엑셀"로 처리         │
│  → 이 프로젝트가 "자동 발주서 생성"을 담당                       │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 전체 데이터 흐름

```
┌───────────────────────────────────────────────────────────────────────────┐
│                             전체 흐름도                                    │
└───────────────────────────────────────────────────────────────────────────┘

    [1] 데이터 입력                [2] 처리                    [3] 출력
    ─────────────            ──────────────────           ─────────────

┌─────────────────┐      ┌─────────────────────┐      ┌─────────────────┐
│                 │      │                     │      │                 │
│ NOAH_SO_PO_DN   │─────▶│    create_po.py     │─────▶│  발주서 Excel   │
│    .xlsx        │      │    (CLI 진입점)      │      │  (Purchase      │
│                 │      │                     │      │   Order)        │
│  ┌───────────┐  │      └─────────────────────┘      │                 │
│  │ SO_국내   │  │              │                    └────────┬────────┘
│  │ SO_해외   │  │              │                             │
│  │ PO_국내   │  │              ▼                             ▼
│  │ PO_해외   │  │      ┌─────────────────────┐      ┌─────────────────┐
│  │ DN_국내   │  │      │                     │      │                 │
│  │ PMT_국내  │  │      │   po_generator/     │      │   이력 파일     │
│  └───────────┘  │      │   (핵심 로직)       │      │  (DB 형식)      │
│                 │      │                     │      │                 │
└─────────────────┘      └─────────────────────┘      └─────────────────┘
                                  │
                                  │ 템플릿 사용
                                  ▼
                         ┌─────────────────────┐
                         │    templates/       │
                         │  purchase_order     │
                         │     .xlsx           │
                         └─────────────────────┘
```

---

## 3. 폴더 구조

```
noahAutomation/
│
├── 📄 create_po.py          # CLI 진입점 (발주서 생성)
├── 📄 create_ts.py          # CLI 진입점 (거래명세표 생성)
├── 📄 create_pi.py          # CLI 진입점 (Proforma Invoice)
│
├── 📁 po_generator/         # ⭐ 핵심 패키지
│   ├── config.py            # 설정/상수 (경로, 필드, 색상)
│   ├── utils.py             # 유틸리티 (데이터 로드, 값 추출)
│   ├── validators.py        # 데이터 검증
│   ├── history.py           # 이력 관리 (중복 체크, 저장)
│   ├── template_engine.py   # 템플릿 처리 (행 복제, 공식 조정)
│   ├── excel_generator.py   # PO Excel 생성 (openpyxl)
│   ├── ts_generator.py      # 거래명세표 생성 (xlwings)
│   └── cli_common.py        # CLI 공통 함수
│
├── 📁 templates/            # 템플릿 파일 (로고/도장 추가 가능)
│   ├── purchase_order.xlsx
│   └── transaction_statement.xlsx
│
├── 📁 generated_po/         # 생성된 발주서 출력 폴더
├── 📁 generated_ts/         # 생성된 거래명세표 출력 폴더
├── 📁 po_history/           # 발주 이력 (월별 폴더)
│   └── 2026/
│       └── 1월/
│           └── 20260118_ND-0001_고객명.xlsx
│
└── 📁 tests/                # 테스트 코드
```

---

## 4. 모듈별 역할

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          모듈 의존 관계도                                │
└─────────────────────────────────────────────────────────────────────────┘

                        ┌─────────────────┐
                        │  create_po.py   │  ◀── 사용자 실행
                        │   (CLI 진입점)   │
                        └────────┬────────┘
                                 │
           ┌─────────────────────┼─────────────────────┐
           │                     │                     │
           ▼                     ▼                     ▼
┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐
│    utils.py     │   │  validators.py  │   │   history.py    │
│  ─────────────  │   │  ─────────────  │   │  ─────────────  │
│ • 데이터 로드   │   │ • 필수필드 체크 │   │ • 중복 발주체크 │
│ • 주문번호 검색 │   │ • ICO Unit 검증 │   │ • 이력 저장     │
│ • 값 추출      │   │ • 납기일 검증   │   │ • 이력 조회     │
└────────┬────────┘   └─────────────────┘   └────────┬────────┘
         │                                           │
         │            ┌─────────────────┐            │
         └───────────▶│    config.py    │◀───────────┘
                      │  ─────────────  │
                      │ • 경로 설정     │
                      │ • 컬럼 별칭     │
                      │ • 상수 정의     │
                      └────────┬────────┘
                               │
           ┌───────────────────┼───────────────────┐
           ▼                   ▼                   ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│template_engine  │ │excel_generator  │ │  ts_generator   │
│  ─────────────  │ │  ─────────────  │ │  ─────────────  │
│ • 템플릿 로드   │ │ • PO 시트 생성  │ │ • 거래명세표    │
│ • 행 복제      │ │ • Desc 시트     │ │   생성 (xlwings)│
│ • 공식 조정    │ │ • 다중아이템    │ │ • 이미지 보존   │
└─────────────────┘ └─────────────────┘ └─────────────────┘
```

---

## 5. 발주서 생성 상세 흐름

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    발주서 생성 프로세스 (Step by Step)                   │
└─────────────────────────────────────────────────────────────────────────┘

사용자 입력                    처리 단계                      결과
──────────                    ────────                      ────

$ python create_po.py ND-0001
          │
          ▼
┌─────────────────┐
│ 1. 데이터 로드  │───▶ load_noah_po_lists()
│                 │     NOAH_SO_PO_DN.xlsx 읽기
│                 │     (SO+PO 시트 병합)
└────────┬────────┘
         ▼
┌─────────────────┐
│ 2. 주문 검색   │───▶ find_order_data(df, "ND-0001")
│                 │     - 단일 아이템 → Series
│                 │     - 다중 아이템 → DataFrame
└────────┬────────┘
         ▼
┌─────────────────┐
│ 3. 중복 체크   │───▶ check_duplicate_order("ND-0001")
│                 │     po_history/**/ 폴더 검색
│                 │     ⚠️ 중복이면 사용자 확인
└────────┬────────┘
         ▼
┌─────────────────┐
│ 4. 데이터 검증 │───▶ validate_order_data()
│                 │     • 필수 필드 체크
│                 │     • ICO Unit > 0
│                 │     • 납기일 유효성
└────────┬────────┘
         ▼
┌─────────────────┐
│ 5. Excel 생성  │───▶ create_po_workbook()
│                 │     ┌────────────────────┐
│                 │     │ 5a. 템플릿 로드    │
│                 │     │     (이미지 포함)   │
│                 │     ├────────────────────┤
│                 │     │ 5b. 헤더 데이터    │
│                 │     │     채움 (Row 1-11) │
│                 │     ├────────────────────┤
│                 │     │ 5c. 아이템 행 처리 │
│                 │     │     (다중이면 복제) │
│                 │     ├────────────────────┤
│                 │     │ 5d. 합계/푸터      │
│                 │     │     업데이트       │
│                 │     └────────────────────┘
└────────┬────────┘
         ▼
┌─────────────────┐      ┌─────────────────────────────┐
│ 6. 파일 저장   │─────▶│ generated_po/               │
│                 │      │   PO_ND-0001_고객명.xlsx    │
└────────┬────────┘      └─────────────────────────────┘
         ▼
┌─────────────────┐      ┌─────────────────────────────┐
│ 7. 이력 저장   │─────▶│ po_history/2026/1월/        │
│                 │      │   20260118_ND-0001_고객명   │
│                 │      │   .xlsx (DB 형식)           │
└─────────────────┘      └─────────────────────────────┘
```

---

## 6. 컬럼 별칭 시스템

Excel 컬럼명이 변경되어도 코드 수정 없이 대응할 수 있습니다.

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          컬럼 별칭 동작 원리                             │
└─────────────────────────────────────────────────────────────────────────┘

    코드에서 사용                  config.py                Excel 파일
    ────────────              ────────────────           ───────────────

  get_value(data,            COLUMN_ALIASES = {         │ Customer name │
    'customer_name')    ───▶   'customer_name': (       │     or        │
        │                        'Customer name',  ───▶ │ 고객명        │
        │                        '고객명',               │     or        │
        │                        '고객사',               │ 고객사        │
        │                      ),                       │               │
        │                    }
        │
        ▼
  resolve_column() 함수가
  실제 컬럼명 자동 탐지

예시:
┌──────────────────────────────────────────────────────────────┐
│ 내부 키         │ 가능한 컬럼명들                             │
├──────────────────────────────────────────────────────────────┤
│ order_no        │ PO_ID, RCK Order no., 주문번호 등          │
│ customer_name   │ Customer name, 고객명, 고객사              │
│ item_qty        │ Item qty, Qty, 수량                        │
│ ico_unit        │ ICO Unit, Unit Price, 단가                 │
│ delivery_date   │ 예상 EXW date, 납기일, Requested delivery  │
└──────────────────────────────────────────────────────────────┘
```

---

## 7. 템플릿 기반 생성

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          템플릿 동작 방식                                │
└─────────────────────────────────────────────────────────────────────────┘

templates/purchase_order.xlsx
       │
       │  load_template()
       ▼
┌─────────────────────────────────────┐
│ 템플릿에서 유지되는 것:             │
│  ✓ 레이아웃 (행/열 구조)            │
│  ✓ 서식 (폰트, 색상, 테두리)        │
│  ✓ 이미지 (로고, 도장)              │
│  ✓ 수식 구조 (SUM, 곱셈 등)         │
├─────────────────────────────────────┤
│ 템플릿에서 무시되는 것:             │
│  ✗ 기존 데이터 값 (새로 채움)       │
└─────────────────────────────────────┘
       │
       │  다중 아이템 처리
       ▼
┌─────────────────────────────────────┐
│ 단일 아이템:                        │
│   템플릿 그대로 사용                │
│                                     │
│ 다중 아이템 (예: 3개):              │
│   Row 13 (템플릿 행) 복제           │
│   → Row 14, 15 삽입                 │
│   → 합계 행/푸터가 아래로 밀림      │
│   → SUM 공식 범위 자동 조정         │
└─────────────────────────────────────┘
```

---

## 8. 이력 관리 시스템

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           이력 관리 구조                                 │
└─────────────────────────────────────────────────────────────────────────┘

po_history/
├── 2026/
│   ├── 1월/
│   │   ├── 20260115_ND-0001_고객A.xlsx   ← 1건 = 1파일 (DB 형식)
│   │   ├── 20260116_ND-0002_고객B.xlsx
│   │   └── 20260118_ND-0003_고객C.xlsx
│   │
│   └── 2월/
│       └── ...
│
└── 2025/
    └── 12월/
        └── ...

이력 파일 내용 (한 행의 DB 형식):
┌──────────────────────────────────────────────────────────────┐
│ 컬럼명          │ 예시 값                                    │
├──────────────────────────────────────────────────────────────┤
│ 생성일시        │ 2026-01-18 14:30:00                       │
│ RCK Order no.   │ ND-0001                                    │
│ Customer name   │ 고객A                                      │
│ 원본파일        │ PO_ND-0001_고객A.xlsx                      │
│ Total net amount│ 1,500,000                                  │
│ Order Total     │ 1,650,000                                  │
│ Model           │ IQ25-F10                                   │
│ Power supply    │ 380-3Ph-50Hz                               │
│ ...             │ (발주서에서 추출한 전체 데이터)            │
└──────────────────────────────────────────────────────────────┘

중복 체크 흐름:
┌─────────────────┐     ┌─────────────────┐
│ ND-0001 발주    │────▶│ po_history/**/  │
│ 요청            │     │ 폴더 검색       │
└─────────────────┘     └────────┬────────┘
                                 │
                   ┌─────────────┴─────────────┐
                   ▼                           ▼
           ┌─────────────┐             ┌─────────────┐
           │ 파일명 패턴 │             │   없음      │
           │ *_ND-0001_* │             │             │
           │   발견!     │             │             │
           └──────┬──────┘             └──────┬──────┘
                  │                           │
                  ▼                           ▼
           ┌─────────────┐             ┌─────────────┐
           │ ⚠️ 경고     │             │ ✅ 정상     │
           │ 중복 발주   │             │    진행     │
           │ 계속? (Y/N) │             │             │
           └─────────────┘             └─────────────┘
```

---

## 9. CLI 사용법 요약

```bash
# 기본 사용
python create_po.py ND-0001

# 여러 건 동시 생성
python create_po.py ND-0001 ND-0002 ND-0003

# 강제 생성 (중복/검증 오류 무시)
python create_po.py ND-0001 --force

# 이력 조회 (현재 월)
python create_po.py --history

# 이력 Excel 내보내기
python create_po.py --history --export

# 도움말
python create_po.py --help
```

---

## 10. 검증 규칙

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           데이터 검증 규칙                               │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────┬─────────────────────────────────────────────┐
│ 검증 항목       │ 규칙                                         │
├─────────────────┼─────────────────────────────────────────────┤
│ 필수 필드       │ Customer name, Customer PO, Item qty,       │
│                 │ Model, ICO Unit 이 비어있으면 [오류]         │
├─────────────────┼─────────────────────────────────────────────┤
│ ICO Unit        │ 0 또는 음수이면 [오류]                       │
├─────────────────┼─────────────────────────────────────────────┤
│ 납기일          │ 과거이면 [오류]                              │
│                 │ 7일 이내이면 [경고]                          │
├─────────────────┼─────────────────────────────────────────────┤
│ 중복 발주       │ 같은 주문번호가 이력에 있으면 [경고]         │
│                 │ 사용자 확인 후 진행 가능                     │
└─────────────────┴─────────────────────────────────────────────┘

--force 옵션: 모든 오류/경고를 무시하고 강제 생성
```

---

## 11. 라이브러리 선택

```
┌──────────────────┬─────────────┬─────────────────────────────────┐
│ 문서 유형        │ 라이브러리  │ 이유                             │
├──────────────────┼─────────────┼─────────────────────────────────┤
│ Purchase Order   │ openpyxl    │ 이미지 없어도 OK, 빠름           │
├──────────────────┼─────────────┼─────────────────────────────────┤
│ 거래명세표       │ xlwings     │ 로고/도장 이미지 필수            │
│ Invoice          │             │ Excel 기본 기능으로 서식 보존    │
│ Packing List     │             │                                 │
└──────────────────┴─────────────┴─────────────────────────────────┘
```

---

## 12. 주요 함수 Quick Reference

| 함수 | 위치 | 역할 |
|------|------|------|
| `load_noah_po_lists()` | utils.py | Excel 데이터 로드 (SO+PO 병합) |
| `find_order_data()` | utils.py | 주문번호로 데이터 검색 |
| `get_value()` | utils.py | 컬럼 별칭 지원하는 값 추출 |
| `validate_order_data()` | validators.py | 단일 아이템 검증 |
| `validate_multiple_items()` | validators.py | 다중 아이템 검증 |
| `check_duplicate_order()` | history.py | 중복 발주 체크 |
| `save_to_history()` | history.py | 이력 저장 (DB 형식) |
| `load_template()` | template_engine.py | 템플릿 파일 로드 |
| `clone_row()` | template_engine.py | 행 복제 (스타일 포함) |
| `create_po_workbook()` | excel_generator.py | PO 워크북 생성 (메인) |
